<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>{{ team_display_name }} - Team Dashboard</title>
    <link rel="stylesheet" href="{{ url_for('static', filename='css/main.css') }}">
    <script src="https://cdn.plot.ly/plotly-2.27.0.min.js"></script>
    <script src="{{ url_for('static', filename='js/theme-toggle.js') }}"></script>
    <script>
        // Get theme-aware colors for charts
        function getChartColors() {
            const isDark = document.documentElement.getAttribute('data-theme') === 'dark';
            return {
                paper_bgcolor: isDark ? '#2d2d2d' : '#ffffff',
                plot_bgcolor: isDark ? '#2d2d2d' : '#ffffff',
                font_color: isDark ? '#e0e0e0' : '#2c3e50',
                grid_color: isDark ? '#444' : '#ecf0f1'
            };
        }
    </script>
</head>
<body>
    <button onclick="toggleTheme()" class="theme-toggle">üåô Dark Mode</button>
    <div class="container">
        <header>
            <h1>{{ team_display_name }}</h1>
            <p class="subtitle">Last updated: {{ updated_at.strftime('%Y-%m-%d %H:%M:%S') }}</p>
            <p class="subtitle" style="margin-top: 8px;">
                üìÖ GitHub Metrics: Last {{ days_back }} days |
                üë§ Person Metrics: Last 365 days
            </p>
            <div class="nav">
                <a href="/">‚Üê Home</a>
                <a href="/team/{{ team_name }}/compare">üë• Compare Members</a>
                <a href="/comparison">Compare Teams</a>
                {% if team_name == 'Native' %}
                <a href="/team/WebTC">WebTC Team ‚Üí</a>
                {% else %}
                <a href="/team/Native">‚Üê Native Team</a>
                {% endif %}
            </div>
        </header>

        <h2 style="margin: 30px 0 15px 0; font-size: 24px;">GitHub Metrics</h2>
        <div class="metrics-grid">
            <div class="card">
                <h2>
                    <a href="https://github.com/pulls?q=is:pr+org:{{ github_org }}+{% for member in team_config.github.members %}author:{{ member }}+{% endfor %}"
                       target="_blank" style="color: inherit; text-decoration: none;">
                        Pull Requests üîó
                    </a>
                </h2>
                <div class="metric-value">{{ team_data.github.pr_count }}</div>
                <div class="metric-label">Total PRs</div>
            </div>
            <div class="card">
                <h2>
                    <a href="https://github.com/pulls?q=is:pr+org:{{ github_org }}+{% for member in team_config.github.members %}reviewed-by:{{ member }}+{% endfor %}"
                       target="_blank" style="color: inherit; text-decoration: none;">
                        Code Reviews üîó
                    </a>
                </h2>
                <div class="metric-value">{{ team_data.github.review_count }}</div>
                <div class="metric-label">Total Reviews</div>
            </div>
            <div class="card">
                <h2>
                    <a href="https://github.com/search?q=org:{{ github_org }}+{% for member in team_config.github.members %}author:{{ member }}+{% endfor %}&type=commits"
                       target="_blank" style="color: inherit; text-decoration: none;">
                        Commits üîó
                    </a>
                </h2>
                <div class="metric-value">{{ team_data.github.commit_count }}</div>
                <div class="metric-label">Total Commits</div>
            </div>
            <div class="card">
                <h2>Avg Cycle Time</h2>
                <div class="metric-value">{{ "%.1f"|format(team_data.github.avg_cycle_time) }}h</div>
                <div class="metric-label">PR Merge Time</div>
            </div>
        </div>

        <div class="card">
            <h2>Team Member Activity</h2>
            <div class="member-grid">
                {% for username, stats in team_data.github.member_trends.items() %}
                <div class="member-card">
                    <div class="member-name">
                        <a href="/person/{{ username }}" style="color: #3498db; text-decoration: none;">{{ username }}</a>
                    </div>
                    <div class="member-stats">
                        PRs: {{ stats.prs }} | Reviews: {{ stats.reviews }}<br>
                        Commits: {{ stats.commits }}<br>
                        Lines: +{{ stats.lines_added }} -{{ stats.lines_deleted }}
                    </div>
                </div>
                {% endfor %}
            </div>
        </div>

        {% if team_data.jira %}
        <h2 style="margin: 40px 0 15px 0; font-size: 24px;">Jira Metrics</h2>

        {% if team_data.jira.throughput %}
        <div class="metrics-grid">
            <div class="card">
                <h2>
                    Throughput (12 weeks)
                    {% if team_config and team_config.get('jira', {}).get('filters', {}).get('completed_12weeks') %}
                    <a href="{{ jira_server }}/issues/?filter={{ team_config.jira.filters.completed_12weeks }}"
                       target="_blank"
                       style="font-size: 0.7em; color: #3498db; text-decoration: none; margin-left: 10px;">
                        üîó View Filter
                    </a>
                    {% endif %}
                </h2>
                <div class="metric-value">{{ "%.1f"|format(team_data.jira.throughput.weekly_avg) }}</div>
                <div class="metric-label">Issues per week</div>
                <div style="margin-top: 10px; font-size: 14px; color: #7f8c8d;">
                    Total completed: {{ team_data.jira.throughput.total_completed }}
                </div>
            </div>

            {% if team_data.jira.wip %}
            <div class="card">
                <h2>
                    Work In Progress
                    {% if team_config and team_config.get('jira', {}).get('filters', {}).get('wip') %}
                    <a href="{{ jira_server }}/issues/?filter={{ team_config.jira.filters.wip }}"
                       target="_blank"
                       style="font-size: 0.7em; color: #3498db; text-decoration: none; margin-left: 10px;">
                        üîó View Filter
                    </a>
                    {% endif %}
                </h2>
                <div class="metric-value">{{ team_data.jira.wip.count }}</div>
                <div class="metric-label">WIP Items</div>
                <div style="margin-top: 10px; font-size: 14px; color: #7f8c8d;">
                    Avg age: {{ "%.1f"|format(team_data.jira.wip.avg_age_days) }} days
                </div>
            </div>
            {% endif %}

            {% if team_data.jira.flagged %}
            <div class="card">
                <h2>
                    Flagged/Blocked
                    {% if team_config and team_config.get('jira', {}).get('filters', {}).get('flagged_blocked') %}
                    <a href="{{ jira_server }}/issues/?filter={{ team_config.jira.filters.flagged_blocked }}"
                       target="_blank"
                       style="font-size: 0.7em; color: #e74c3c; text-decoration: none; margin-left: 10px;">
                        üîó View Filter
                    </a>
                    {% endif %}
                </h2>
                <div class="metric-value {% if team_data.jira.flagged.count > 0 %}attention{% endif %}">
                    {{ team_data.jira.flagged.count }}
                </div>
                <div class="metric-label">Blocked Issues</div>
            </div>
            {% endif %}

            {% if team_data.jira.bugs %}
            <div class="card">
                <h2>
                    Bugs (Created / Resolved)
                    {% if team_config and team_config.get('jira', {}).get('filters', {}).get('bugs') %}
                    <a href="{{ jira_server }}/issues/?filter={{ team_config.jira.filters.bugs }}"
                       target="_blank"
                       style="font-size: 0.7em; color: #3498db; text-decoration: none; margin-left: 10px;">
                        üîó View Filter
                    </a>
                    {% endif %}
                </h2>
                <div class="metric-value">{{ team_data.jira.bugs.created }} / {{ team_data.jira.bugs.resolved }}</div>
                <div class="metric-label">Created / Resolved</div>
                <div style="margin-top: 10px; font-size: 14px; color: {% if team_data.jira.bugs.net > 0 %}#e74c3c{% else %}#27ae60{% endif %};">
                    Net: {% if team_data.jira.bugs.net > 0 %}+{% endif %}{{ team_data.jira.bugs.net }}
                </div>
            </div>
            {% endif %}
        </div>

        {% if team_data.jira.throughput and team_data.jira.throughput.by_type %}
        <div class="card">
            <h2>Throughput by Issue Type</h2>
            <div id="throughput-types-chart" style="height: 400px;"></div>
        </div>

        <script>
            const typeData = {{ team_data.jira.throughput.by_type | tojson }};
            const colors = getChartColors();

            Plotly.newPlot('throughput-types-chart', [{
                labels: Object.keys(typeData),
                values: Object.values(typeData),
                type: 'pie',
                marker: {
                    colors: ['#3498db', '#e74c3c', '#2ecc71', '#f39c12', '#9b59b6', '#1abc9c', '#e67e22']
                },
                textinfo: 'label+percent',
                textposition: 'outside'
            }], {
                paper_bgcolor: colors.paper_bgcolor,
                font: {color: colors.font_color},
                showlegend: true,
                height: 400
            }, {responsive: true});
        </script>
        {% endif %}

        {% endif %}

        {% if team_data.jira.wip and team_data.jira.wip.age_distribution %}
        <div class="card">
            <h2>WIP Age Distribution</h2>
            <div id="wip-chart"></div>
            <script>
                var data = [{
                    x: Object.keys({{ team_data.jira.wip.age_distribution|tojson }}),
                    y: Object.values({{ team_data.jira.wip.age_distribution|tojson }}),
                    type: 'bar',
                    marker: {color: '#3498db'}
                }];
                // Get theme-aware colors
                const isDark = document.documentElement.getAttribute('data-theme') === 'dark';
                const chartColors = {
                    paper_bgcolor: isDark ? '#2d2d2d' : '#ffffff',
                    plot_bgcolor: isDark ? '#2d2d2d' : '#ffffff',
                    font_color: isDark ? '#e0e0e0' : '#2c3e50',
                    grid_color: isDark ? '#444' : '#ecf0f1'
                };

                var layout = {
                    title: 'Days in WIP Status',
                    xaxis: {
                        title: 'Age Range',
                        gridcolor: chartColors.grid_color,
                        color: chartColors.font_color
                    },
                    yaxis: {
                        title: 'Number of Issues',
                        gridcolor: chartColors.grid_color,
                        color: chartColors.font_color
                    },
                    paper_bgcolor: chartColors.paper_bgcolor,
                    plot_bgcolor: chartColors.plot_bgcolor,
                    font: {color: chartColors.font_color},
                    height: 300
                };
                Plotly.newPlot('wip-chart', data, layout);
            </script>
        </div>
        {% endif %}

        {% if team_data.jira.wip and team_data.jira.wip.by_status %}
        <div class="card">
            <h2>WIP Items by Status</h2>
            <div id="wip-status-chart" style="height: 400px;"></div>
        </div>

        <script>
            const statusData = {{ team_data.jira.wip.by_status | tojson }};
            const colors = getChartColors();

            Plotly.newPlot('wip-status-chart', [{
                x: Object.values(statusData),
                y: Object.keys(statusData),
                type: 'bar',
                orientation: 'h',
                marker: {color: '#3498db'}
            }], {
                paper_bgcolor: colors.paper_bgcolor,
                plot_bgcolor: colors.plot_bgcolor,
                font: {color: colors.font_color},
                xaxis: {
                    title: 'Number of Issues',
                    gridcolor: colors.grid_color,
                    color: colors.font_color
                },
                yaxis: {
                    title: 'Status',
                    gridcolor: colors.grid_color,
                    color: colors.font_color
                },
                height: 400,
                margin: {l: 150}
            }, {responsive: true});
        </script>
        {% endif %}

        {% if team_data.jira.bugs and team_data.jira.bugs.trend_created %}
        <div class="card">
            <h2>Bugs: Created vs Resolved (Last 12 Weeks)</h2>
            <div id="bugs-trend-chart" style="height: 400px;"></div>
        </div>

        <script>
            const bugsCreated = {{ team_data.jira.bugs.trend_created | tojson }};
            const bugsResolved = {{ team_data.jira.bugs.trend_resolved | tojson }};
            const colors = getChartColors();

            // Merge weeks from both datasets
            const allWeeks = [...new Set([...Object.keys(bugsCreated), ...Object.keys(bugsResolved)])].sort();

            Plotly.newPlot('bugs-trend-chart', [
                {
                    x: allWeeks,
                    y: allWeeks.map(w => bugsCreated[w] || 0),
                    type: 'scatter',
                    mode: 'lines+markers',
                    name: 'Created',
                    line: {color: '#e74c3c', width: 2},
                    marker: {color: '#e74c3c', size: 6}
                },
                {
                    x: allWeeks,
                    y: allWeeks.map(w => bugsResolved[w] || 0),
                    type: 'scatter',
                    mode: 'lines+markers',
                    name: 'Resolved',
                    line: {color: '#2ecc71', width: 2},
                    marker: {color: '#2ecc71', size: 6}
                }
            ], {
                paper_bgcolor: colors.paper_bgcolor,
                plot_bgcolor: colors.plot_bgcolor,
                font: {color: colors.font_color},
                xaxis: {
                    title: 'Week',
                    gridcolor: colors.grid_color,
                    color: colors.font_color
                },
                yaxis: {
                    title: 'Number of Bugs',
                    gridcolor: colors.grid_color,
                    color: colors.font_color
                },
                showlegend: true,
                height: 400
            }, {responsive: true});
        </script>
        {% endif %}

        {% if team_data.jira.scope and team_data.jira.scope.trend_created %}
        <div class="card">
            <h2>Scope: Created vs Resolved (Last 12 Weeks)</h2>
            <div id="scope-trend-chart" style="height: 400px;"></div>
        </div>

        <script>
            const scopeCreated = {{ team_data.jira.scope.trend_created | tojson }};
            const scopeResolved = {{ team_data.jira.scope.trend_resolved | tojson }};
            const colors = getChartColors();

            const allWeeksScope = [...new Set([...Object.keys(scopeCreated), ...Object.keys(scopeResolved)])].sort();

            Plotly.newPlot('scope-trend-chart', [
                {
                    x: allWeeksScope,
                    y: allWeeksScope.map(w => scopeCreated[w] || 0),
                    type: 'scatter',
                    mode: 'lines+markers',
                    name: 'Created',
                    line: {color: '#3498db', width: 2},
                    marker: {color: '#3498db', size: 6}
                },
                {
                    x: allWeeksScope,
                    y: allWeeksScope.map(w => scopeResolved[w] || 0),
                    type: 'scatter',
                    mode: 'lines+markers',
                    name: 'Resolved',
                    line: {color: '#9b59b6', width: 2},
                    marker: {color: '#9b59b6', size: 6}
                }
            ], {
                paper_bgcolor: colors.paper_bgcolor,
                plot_bgcolor: colors.plot_bgcolor,
                font: {color: colors.font_color},
                xaxis: {
                    title: 'Week',
                    gridcolor: colors.grid_color,
                    color: colors.font_color
                },
                yaxis: {
                    title: 'Number of Issues',
                    gridcolor: colors.grid_color,
                    color: colors.font_color
                },
                showlegend: true,
                height: 400
            }, {responsive: true});
        </script>
        {% endif %}

        {% if team_data.jira.flagged and team_data.jira.flagged.issues %}
        <div class="card">
            <h2>
                Flagged/Blocked Issues
                {% if team_config and team_config.get('jira', {}).get('filters', {}).get('flagged_blocked') %}
                <a href="{{ jira_server }}/issues/?filter={{ team_config.jira.filters.flagged_blocked }}"
                   target="_blank"
                   style="font-size: 0.7em; color: #e74c3c; text-decoration: none; margin-left: 10px;">
                    üîó View in Jira
                </a>
                {% endif %}
            </h2>
            <table>
                <thead>
                    <tr>
                        <th>Issue</th>
                        <th>Summary</th>
                        <th>Assignee</th>
                        <th>Days Blocked</th>
                    </tr>
                </thead>
                <tbody>
                    {% for issue in team_data.jira.flagged.issues %}
                    <tr>
                        <td>
                            <strong>
                                <a href="{{ jira_server }}/browse/{{ issue.key }}"
                                   target="_blank"
                                   style="color: #3498db; text-decoration: none;">
                                    {{ issue.key }} üîó
                                </a>
                            </strong>
                        </td>
                        <td>{{ issue.summary[:60] }}...</td>
                        <td>{{ issue.assignee }}</td>
                        <td class="attention">{{ issue.days_blocked }}</td>
                    </tr>
                    {% endfor %}
                </tbody>
            </table>
        </div>
        {% endif %}
        {% endif %}
    </div>
</body>
</html>
