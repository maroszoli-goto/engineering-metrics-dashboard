{% extends "base.html" %}

{% block title %}Performance Metrics - Team Metrics Dashboard{% endblock %}

{% block content %}
<div class="container">
    <!-- Breadcrumb Navigation -->
    {% from 'components/breadcrumb.html' import breadcrumb %}
    <div style="margin-bottom: 30px; padding: 15px 0; border-bottom: 1px solid var(--border-color); display: flex; justify-content: space-between; align-items: center;">
        <div style="flex: 1;">
            {{ breadcrumb([
                {'label': 'üè† Home', 'url': '/'},
                {'label': 'üìà Performance Metrics', 'url': None}
            ]) }}
        </div>

        <!-- Hamburger Menu Icon -->
        <label for="hamburger-toggle" class="hamburger-icon-inline">
            <span></span>
            <span></span>
            <span></span>
        </label>
    </div>

    <!-- Header -->
    <div class="header">
        <h1>üìä Performance Metrics</h1>
        <p>Monitor route performance, cache effectiveness, and system health over the last {{ days_back }} days</p>
    </div>

    <!-- Health Score Card -->
    <div class="card" style="margin-bottom: 2rem;">
        <h2>üéØ Performance Health Score</h2>
        <div style="text-align: center; padding: 2rem 0;">
            <div style="font-size: 4rem; font-weight: bold;
                {% if health_score.total_score >= 90 %}color: #10b981;
                {% elif health_score.total_score >= 70 %}color: #f59e0b;
                {% else %}color: #ef4444;{% endif %}">
                {{ health_score.grade }}
            </div>
            <div style="font-size: 2rem; color: var(--text-secondary); margin-top: 0.5rem;">
                {{ health_score.total_score }}/100
            </div>
        </div>

        <div style="display: grid; grid-template-columns: repeat(3, 1fr); gap: 1rem; margin-top: 2rem;">
            <div style="text-align: center;">
                <div style="font-size: 1.5rem; font-weight: bold;">{{ health_score.latency_score }}</div>
                <div style="color: var(--text-secondary);">Latency Score</div>
            </div>
            <div style="text-align: center;">
                <div style="font-size: 1.5rem; font-weight: bold;">{{ health_score.cache_score }}</div>
                <div style="color: var(--text-secondary);">Cache Score</div>
            </div>
            <div style="text-align: center;">
                <div style="font-size: 1.5rem; font-weight: bold;">{{ health_score.error_score }}</div>
                <div style="color: var(--text-secondary);">Error Score</div>
            </div>
        </div>
    </div>

    <!-- Overview Stats -->
    <div style="display: grid; grid-template-columns: repeat(auto-fit, minmax(250px, 1fr)); gap: 1rem; margin-bottom: 2rem;">
        <div class="card">
            <h3>Total Requests</h3>
            <div style="font-size: 2rem; font-weight: bold; margin-top: 0.5rem;">
                {{ "{:,}".format(overview.total_requests) }}
            </div>
            <div style="color: var(--text-secondary); font-size: 0.9rem; margin-top: 0.5rem;">
                Across {{ overview.total_routes }} routes
            </div>
        </div>

        <div class="card">
            <h3>Avg Response Time</h3>
            <div style="font-size: 2rem; font-weight: bold; margin-top: 0.5rem;">
                {{ "%.0f"|format(overview.avg_response_time_ms) }} ms
            </div>
            <div style="color: var(--text-secondary); font-size: 0.9rem; margin-top: 0.5rem;">
                P95: {{ "%.0f"|format(overview.p95_response_time_ms) }} ms
            </div>
        </div>

        <div class="card">
            <h3>Cache Hit Rate</h3>
            <div style="font-size: 2rem; font-weight: bold; margin-top: 0.5rem;">
                {{ "%.1f"|format(overview.cache_hit_rate) }}%
            </div>
            <div style="color: var(--text-secondary); font-size: 0.9rem; margin-top: 0.5rem;">
                {% if overview.cache_hit_rate >= 70 %}
                <span style="color: #10b981;">‚úì Excellent</span>
                {% elif overview.cache_hit_rate >= 50 %}
                <span style="color: #f59e0b;">‚ö† Good</span>
                {% else %}
                <span style="color: #ef4444;">‚ö† Needs Improvement</span>
                {% endif %}
            </div>
        </div>

        <div class="card">
            <h3>Slowest Route</h3>
            <div style="font-size: 1rem; font-weight: bold; margin-top: 0.5rem; font-family: monospace;">
                {{ overview.slowest_route if overview.slowest_route else "N/A" }}
            </div>
            <div style="color: var(--text-secondary); font-size: 0.9rem; margin-top: 0.5rem;">
                By P95 latency
            </div>
        </div>
    </div>

    <!-- Performance Trend Chart -->
    <div class="card" style="margin-bottom: 2rem;">
        <h2>üìà Performance Trend (Last {{ days_back }} Days)</h2>
        <div id="performance-trend-chart"></div>
    </div>

    <!-- Slowest Routes Table -->
    <div class="card" style="margin-bottom: 2rem;">
        <h2>üêå Slowest Routes</h2>
        <table class="metrics-table">
            <thead>
                <tr>
                    <th>Route</th>
                    <th>Requests</th>
                    <th>Avg (ms)</th>
                    <th>P50 (ms)</th>
                    <th>P95 (ms)</th>
                    <th>P99 (ms)</th>
                    <th>Cache Hit Rate</th>
                    <th>Status</th>
                </tr>
            </thead>
            <tbody>
                {% for route in slow_routes %}
                <tr>
                    <td style="font-family: monospace; font-size: 0.85rem;">{{ route.route }}</td>
                    <td>{{ "{:,}".format(route.count) }}</td>
                    <td>{{ "%.0f"|format(route.avg_ms) }}</td>
                    <td>{{ "%.0f"|format(route.p50_ms) }}</td>
                    <td>{{ "%.0f"|format(route.p95_ms) }}</td>
                    <td>{{ "%.0f"|format(route.p99_ms) }}</td>
                    <td>{{ "%.1f"|format(route.cache_hit_rate) }}%</td>
                    <td>
                        <span style="background-color: {{ route.color }}20; color: {{ route.color }};
                                     padding: 0.25rem 0.5rem; border-radius: 4px; font-size: 0.85rem;">
                            {{ route.severity }}
                        </span>
                    </td>
                </tr>
                {% endfor %}
            </tbody>
        </table>
    </div>

    <!-- Cache Effectiveness -->
    <div class="card" style="margin-bottom: 2rem;">
        <h2>üíæ Cache Effectiveness</h2>

        <div style="margin-bottom: 2rem;">
            <h3>Overall Hit Rate: {{ "%.1f"|format(cache_effectiveness.overall_hit_rate) }}%</h3>
        </div>

        <div style="display: grid; grid-template-columns: repeat(auto-fit, minmax(300px, 1fr)); gap: 1.5rem;">
            <!-- High Hit Rate -->
            <div>
                <h4 style="color: #10b981;">‚úì High Hit Rate (‚â•70%)</h4>
                <ul style="margin-top: 0.5rem;">
                    {% for route in cache_effectiveness.high_hit_rate_routes[:5] %}
                    <li style="font-family: monospace; font-size: 0.85rem; margin-bottom: 0.5rem;">
                        {{ route.route }} - {{ "%.1f"|format(route.cache_hit_rate) }}%
                    </li>
                    {% else %}
                    <li style="color: var(--text-tertiary);">No routes</li>
                    {% endfor %}
                </ul>
            </div>

            <!-- Low Hit Rate -->
            <div>
                <h4 style="color: #f59e0b;">‚ö† Low Hit Rate (<70%)</h4>
                <ul style="margin-top: 0.5rem;">
                    {% for route in cache_effectiveness.low_hit_rate_routes[:5] %}
                    <li style="font-family: monospace; font-size: 0.85rem; margin-bottom: 0.5rem;">
                        {{ route.route }} - {{ "%.1f"|format(route.cache_hit_rate) }}%
                    </li>
                    {% else %}
                    <li style="color: var(--text-tertiary);">No routes</li>
                    {% endfor %}
                </ul>
            </div>

            <!-- No Cache -->
            <div>
                <h4 style="color: #ef4444;">‚úó No Cache (0%)</h4>
                <ul style="margin-top: 0.5rem;">
                    {% for route in cache_effectiveness.no_cache_routes[:5] %}
                    <li style="font-family: monospace; font-size: 0.85rem; margin-bottom: 0.5rem;">
                        {{ route.route }}
                    </li>
                    {% else %}
                    <li style="color: var(--text-tertiary);">No routes</li>
                    {% endfor %}
                </ul>
            </div>
        </div>
    </div>

    <!-- Storage Info -->
    <div class="card">
        <h2>üíΩ Storage Information</h2>
        <div style="display: grid; grid-template-columns: repeat(2, 1fr); gap: 1rem;">
            <div>
                <strong>Database Size:</strong> {{ storage_info.database_size }}
            </div>
            <div>
                <strong>Total Records:</strong> {{ "{:,}".format(storage_info.total_records) }}
            </div>
        </div>
        <div style="margin-top: 1rem; color: var(--text-secondary); font-size: 0.9rem;">
            Data is automatically rotated after 90 days
        </div>
    </div>
</div>

<!-- Plotly Chart Script -->
<script>
document.addEventListener('DOMContentLoaded', function() {
    // Parse trend data from server
    var trendData = {{ trend_data | tojson | safe }};

    // Convert ISO timestamps to Date objects
    var timestamps = trendData.timestamps.map(ts => new Date(ts));

    // Create traces
    var avgTrace = {
        x: timestamps,
        y: trendData.avg_latency,
        name: 'Avg Latency',
        type: 'scatter',
        mode: 'lines',
        line: { color: '#3b82f6', width: 2 }
    };

    var p95Trace = {
        x: timestamps,
        y: trendData.p95_latency,
        name: 'P95 Latency',
        type: 'scatter',
        mode: 'lines',
        line: { color: '#ef4444', width: 2, dash: 'dash' }
    };

    var layout = {
        title: '',
        xaxis: {
            title: 'Time',
            gridcolor: 'var(--border-color)'
        },
        yaxis: {
            title: 'Latency (ms)',
            gridcolor: 'var(--border-color)'
        },
        legend: {
            x: 0,
            y: 1.1,
            orientation: 'h'
        },
        plot_bgcolor: 'var(--background-color)',
        paper_bgcolor: 'var(--card-background)',
        font: { color: 'var(--text-primary)' },
        margin: { t: 20, b: 60, l: 60, r: 20 }
    };

    var config = {
        responsive: true,
        displayModeBar: false
    };

    Plotly.newPlot('performance-trend-chart', [avgTrace, p95Trace], layout, config);
});
</script>
{% endblock %}
